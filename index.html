<html>
  <head>
  </head>
  <body>
    <div id="race_container">
      <table id="track">
        <tr>
          <th id="bracket_header" class="bracket-header">
            Êû†Áï™<br>
            <span class="text-small">Bracket #</span>
          </th>
          <th class="horse-number">
            È¶¨Áï™<br>
            <span class="text-small">Horse #</span>
          </th>
          <th class="lane">
            <span class="start text-small">Start</span>
            <span class="finish text-small">Finish</span>
          </th>
          <th class="place">
            ÁùÄ<br>
            <span class="text-small">Place</span>
          </th>
        <tr>
      </table>
    </div>
    <div id="controls">
      Number of Horses:
      <input type="number" id="num_horses">
      <button id="start">Start</button>
    </div>
    <div id="settings" cellspacing="0">
      <table>
        <tr>
          <th>Ë≥≠Âºè(„Åã„Åë„Åó„Åç - Bet)</th>
          <th>Options</th>
          <th>%</th>
          <th>Description</th>
        </tr>
        <tr id="bet_tanshou">
          <td class="bet">ÂçòÂãù(„Åü„Çì„Åó„Çá„ÅÜ - Win)</td>
          <td class="options">
            <input type="number"></input>
          </td>
          <td id="p_tanshou" class="probability"></td>
          <td class="desc">Bet which horse will place 1st</td>
        </tr>
        <tr id="bet_fukushou">
          <td class="bet">Ë§áÂãù(„Åµ„Åè„Åó„Çá„ÅÜ - Places)</td>
          <td class="options">
            <input type="number"></input>
          </td>
          <td id="p_fukushou" class="probability"></td>
          <td class="desc">Bet which horse will place top 3 (top 2 if there are &lt; 8 horses)</td>
        </tr>
        <tr id="bet_wakufuku">
          <td class="bet">Êû†Ë§á(„Çè„Åè„Åµ„Åè - Bracket Quinella)</td>
          <td class="options">
            <input type="number"></input> ‚Äï <input type="number"></input>
          </td>
          <td id="p_wakufuku" class="probability"></td>
          <td class="desc">
            Bet which brackets' horses will place top 2, in any order<br>
            Also called Êû†ÈÄ£(„Çè„Åè„Çå„Çì)
          </td>
        </tr>
        <tr id="bet_wakutan">
          <td class="bet">Êû†Âçò(„Çè„Åè„Åü„Çì - Bracket Exacta)</td>
          <td class="options">
            <input type="number"></input> ‚Üí <input type="number"></input>
          </td>
          <td id="p_wakutan" class="probability"></td>
          <td class="desc">Bet which brackets' horses will place top 2, in order</td>
        </tr>
        <tr id="bet_umafuku">
          <td class="bet">È¶¨Ë§á(„ÅÜ„Åæ„Åµ„Åè - Quinella)</td>
          <td class="options">
            <input type="number"></input> ‚Äï <input type="number"></input>
          </td>
          <td id="p_umafuku" class="probability"></td>
          <td class="desc">
            Bet which 2 horses will place top 2, in any order<br>
            Also called È¶¨ÈÄ£(„ÅÜ„Åæ„Çå„Çì)
          </td>
        </tr>
        <tr id="bet_umatan">
          <td class="bet">È¶¨Âçò(„ÅÜ„Åæ„Åü„Çì - Exacta)</td>
          <td class="options">
            <input type="number"></input> ‚Üí <input type="number"></input>
          </td>
          <td id="p_umatan" class="probability"></td>
          <td class="desc">Bet which 2 horses will place top 2, in order (difficult)</td>
        </tr>
        <tr id="bet_wide">
          <td class="bet">„ÉØ„Ç§„Éâ(Wide)</td>
          <td class="options">
            <input type="number"></input> ‚Äï <input type="number"></input>
          </td>
          <td id="p_wide" class="probability"></td>
          <td class="desc">Bet which 2 horses will place top 3, in any order</td>
        </tr>
        <tr id="bet_sanrenfuku">
          <td class="bet">3ÈÄ£Ë§á(„Åï„Çì„Çå„Çì„Åµ„Åè - Trio)</td>
          <td class="options">
            <input type="number"></input> ‚Äï <input type="number"></input> ‚Äï <input type="number"></input>
          </td>
          <td id="p_sanrenfuku" class="probability"></td>
          <td class="desc">Bet which 3 horses will place top 3, in any order</td>
        </tr>
        <tr id="bet_umarentan">
          <td class="bet">3ÈÄ£Âçò(„Åï„Çì„Çå„Çì„Åü„Çì - Trifecta)</td>
          <td class="options">
            <input type="number"></input> ‚Üí <input type="number"></input> ‚Üí <input type="number"></input>
          </td>
          <td id="p_umarentan" class="probability"></td>
          <td class="desc">
            Bet which 3 horses will place top 3, in order (this is the most difficult)<br>
            Also called 3ÈÄ£Âçò(„Åï„Çì„Çå„Çì„Åü„Çì)
          </td>
        </tr>
      </table>
    </div>
  </body>

  <style>
    body { padding: 10px; }
    #track th,
    #track td,
    #settings th,
    #settings td { border: 1px solid #999; }

    #track { width: 50%; }
      #track .bracket-header,
      #track .horse-number,
      #track .place {
        width: 5%;
        white-space: nowrap;
      }
      #track .lane { width: 85%; }
      #track .bracket-1 { background: #DDD; }
      #track .bracket-2 { background: #666; }
      #track .bracket-3 { background: #F66; }
      #track .bracket-4 { background: #66F; }
      #track .bracket-5 { background: #FF6; }
      #track .bracket-6 { background: #6F6; }
      #track .bracket-7 { background: #FB9; }
      #track .bracket-8 { background: #F9B; }
      #track .horse {
        width: 0;
        text-align: right;
      }

    #controls { padding-top: 20px; }

    #settings { margin-top: 10px; }
      #settings input:disabled { background: #EEE; }

    .text-small { font-size: 80%; }
    .start { float: left; }
    .finish { float: right; }
    .probability { width: 4em; }
      .probability:after { content: 'ÔºÖ'; }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
  </style>

  <script>
    const MIN_HORSES = 1;
    const MAX_HORSES = 16;
    const BRACKET_SIZE = 2;
    const NUM_BRACKETS = MAX_HORSES / BRACKET_SIZE;
    const RACE_INTERVAL = 1000 / 30; // fps
    const SPEED = 3;

    const COLOURS = {
      GOLD: '#EE5',
      SILVER: '#DDE',
      BRONZE: '#BA6',
      WIN: '#6F6',
      DEFAULT: '#FFF',
    };

    const $track = document.querySelector('#track');
    const $bracketHeader = document.querySelector('#bracket_header');
    const $numHorses = document.querySelector('#num_horses');
    const $start = document.querySelector('#start');
    const $settings = document.querySelector('#settings');
    const brackets = [];

    const tanshou = {
      $inputs: document.querySelectorAll('#bet_tanshou input'),
      $probability: document.querySelector('#p_tanshou'),
    };
    const fukushou = {
      $inputs: document.querySelectorAll('#bet_fukushou input'),
      $probability: document.querySelector('#p_fukushou'),
    };
    const wakufuku = {
      $inputs: document.querySelectorAll('#bet_wakufuku input'),
      $probability: document.querySelector('#p_wakufuku'),
    };
    const wakutan = {
      $inputs: document.querySelectorAll('#bet_wakutan input'),
      $probability: document.querySelector('#p_wakutan'),
    };
    const umafuku = {
      $inputs: document.querySelectorAll('#bet_umafuku input'),
      $probability: document.querySelector('#p_umafuku'),
    };
    const umatan = {
      $inputs: document.querySelectorAll('#bet_umatan input'),
      $probability: document.querySelector('#p_umatan'),
    };
    const wide = {
      $inputs: document.querySelectorAll('#bet_wide input'),
      $probability: document.querySelector('#p_wide'),
    };
    const sanrenfuku = {
      $inputs: document.querySelectorAll('#bet_sanrenfuku input'),
      $probability: document.querySelector('#p_sanrenfuku'),
    };
    const umarentan = {
      $inputs: document.querySelectorAll('#bet_umarentan input'),
      $probability: document.querySelector('#p_umarentan'),
    };

    let intervalId = null;
    let places = [];

    $numHorses.addEventListener('change', function () {
      this.value = Math.min(MAX_HORSES, Math.max(MIN_HORSES, this.value)) || 1;

      clearTrack();
      makeBrackets(this.value);
      fillTrack();

      if (this.value <= NUM_BRACKETS) {
        $bracketHeader.style.display = 'none';
        document.querySelectorAll('.js-bracket').forEach($bracket => $bracket.style.display = 'none');
      } else {
        $bracketHeader.style.display = 'table-cell';
      }

      adjustBets(this.value);
    });

    function clearTrack() {
      for (let i = 0; i < NUM_BRACKETS; i++) {
        brackets[i] = [];
      }

      document.querySelectorAll('.js-lane').forEach($lane => $lane.remove());
    }

    function makeBrackets(numHorses) {
      console.log('makeBrackets');

      for (let i = 1; i <= numHorses; i++) {
        bracket = ((NUM_BRACKETS * 2) - i) % NUM_BRACKETS;

        const $lane = document.createElement('tr');
        $lane.className = 'js-lane';

        const $horseNumber = document.createElement('td');
        $lane.appendChild($horseNumber);

        const $horseHolder = document.createElement('td');
        const $horse = document.createElement('div');
        $horse.innerText = 'üê¥';
        $horse.className = 'horse';
        $horseHolder.appendChild($horse);
        $lane.appendChild($horseHolder);

        const $place = document.createElement('td');
        $lane.appendChild($place);

        brackets[bracket].push({
          $html: $lane,
          $horseNumber: $horseNumber,
          $horse: $horse,
          $place: $place,
          bracketNumber: 0,
          horseNumber: 0,
        });
      }
    }

    function fillTrack() {
      console.log('fillTrack');

      let horseNumber = 1;
      for (let i = 0; i < brackets.length; i++) {
        if (brackets[i].length === 0) continue;

        const bracketNumber = i + 1;

        const $bracketNumber = document.createElement('td');
        $bracketNumber.className = 'js-bracket bracket-' + bracketNumber;
        $bracketNumber.innerText = bracketNumber;
        $bracketNumber.rowSpan = brackets[i].length;
        brackets[i][0].$html.insertBefore($bracketNumber, brackets[i][0].$horseNumber);

        for (let j = 0; j < brackets[i].length; j++) {
          brackets[i][j].bracketNumber = bracketNumber;
          brackets[i][j].horseNumber = horseNumber
          brackets[i][j].$horseNumber.innerText = horseNumber;
          horseNumber += 1;
          $track.append(brackets[i][j].$html);
        }
      }
    }

    function adjustBets(numHorses) {
      update(tanshou, parseInt(numHorses) === 1, () => 1 / numHorses);
      update(fukushou, numHorses < 5, () => (numHorses < NUM_BRACKETS ? 2 : 3) / numHorses);

      update(wakufuku, numHorses <= NUM_BRACKETS, function () {
        let bracket1Length = (brackets[wakufuku.$inputs[0].value - 1] || []).length;
        let bracket2Length = (brackets[wakufuku.$inputs[1].value - 1] || []).length;
        return (bracket1Length * bracket2Length * 2) / (numHorses * (numHorses - 1));
      });

      update(wakutan, numHorses <= NUM_BRACKETS, function () {
        let bracket1Length = (brackets[wakufuku.$inputs[0].value - 1] || []).length;
        let bracket2Length = (brackets[wakufuku.$inputs[1].value - 1] || []).length;
        return (bracket1Length * bracket2Length) / (numHorses * (numHorses - 1));
      });

      update(umafuku, numHorses < 3, () => 2 / (numHorses * (numHorses - 1)))
      update(umatan, numHorses < 3, () => 1 / (numHorses * (numHorses - 1)));
      update(wide, numHorses < 4, () => 6 / (numHorses * (numHorses - 1)));
      update(sanrenfuku, numHorses < 4, () => 6 / (numHorses * (numHorses - 1) * (numHorses - 2)));
      update(umarentan, numHorses < 4, () => 1 / (numHorses * (numHorses - 1) * (numHorses - 2)));
    }

    function update(bet, disabled, calculate) {
      let hasInput = true;
      bet.$inputs.forEach(function ($input) {
        $input.disabled = disabled;
        hasInput &= ($input.value != '');
      });

      bet.$probability.innerText = hasInput && !disabled ? Math.round(calculate() * 10000) / 100 : 0;
    }

    $start.addEventListener('click', function () {
      if (intervalId !== null) return;

      console.log('start race with ' + $numHorses.value + ' horses');

      // reset
      for (let i = 0; i < brackets.length; i++) {
        for (let j = 0; j < brackets[i].length; j++) {
          brackets[i][j].$horse.style.width = 0;
          brackets[i][j].$place.innerText = '';
          brackets[i][j].$place.style.background = COLOURS.DEFAULT;
        }
      }
      places = [];
      checkBets();

      intervalId = window.setInterval(function () {
        for (let i = 0; i < brackets.length; i++) {
          for (let j = 0; j < brackets[i].length; j++) {
            let progress = parseInt(brackets[i][j].$horse.style.width) || 0;

            if (progress >= 100) continue;

            progress += Math.ceil(Math.random() * SPEED);

            if (progress >= 100) finishHorse(brackets[i][j]);

            brackets[i][j].$horse.style.width = Math.min(100, progress) + '%';
          }
        }

        if (places.length == $numHorses.value) {
          window.clearInterval(intervalId);
          intervalId = null;
          checkBets();
        }
      }, RACE_INTERVAL);
    });

    function finishHorse(horse) {
      places.push(horse);
      horse.$place.innerText = places.length;

      if (places.length === 1) {
        horse.$place.style.background = COLOURS.GOLD;
      } else if (places.length === 2) {
        horse.$place.style.background = COLOURS.SILVER;
      } else if (places.length === 3) {
        horse.$place.style.background = COLOURS.BRONZE;
      }

      console.log('horse #' + horse.horseNumber + ' (bracket #' + horse.bracketNumber + ') finishes');
    }

    function checkBets() {
      const done = places.length > 0;
      const p1 = places[0];
      const p2 = places[1];
      const p3 = places[2];

      let b1 = 0;
      let b2 = 0;
      let b3 = 0;

      // horse is 1st
      b1 = parseInt(tanshou.$inputs[0].value);
      checkWin(tanshou, done && !tanshou.$inputs[0].disabled && (
        b1 === p1.horseNumber
      ));

      // horse is in top 3 (top 2 if < 8 horses)
      b1 = parseInt(fukushou.$inputs[0].value);
      checkWin(fukushou, done && !fukushou.$inputs[0].disabled && (
          b1 === p1.horseNumber
          || b1 === p2.horseNumber
          || ($numHorses.value > NUM_BRACKETS && b1 === p3.horseNumber)
      ));

      // 2 brackets' horses are in top 2, any order
      b1 = parseInt(wakufuku.$inputs[0].value);
      b2 = parseInt(wakufuku.$inputs[1].value);
      checkWin(wakufuku, done && !wakufuku.$inputs[0].disabled && (
        (b1 === p1.bracketNumber && b2 === p2.bracketNumber)
        || (b1 === p2.bracketNumber && b2 === p1.bracketNumber)
      ));

      // 2 brackets' horse are in top 2, in order
      b1 = parseInt(wakutan.$inputs[0].value);
      b2 = parseInt(wakutan.$inputs[1].value);
      checkWin(wakutan, done && !wakutan.$inputs[0].disabled && (
        b1 === p1.bracketNumber && b2 === p2.bracketNumber
      ));

      // 2 horses are in top 2, any order
      b1 = parseInt(umafuku.$inputs[0].value);
      b2 = parseInt(umafuku.$inputs[1].value);
      checkWin(umafuku, done && !umafuku.$inputs[0].disabled && (
        (b1 === p1.horseNumber && b2 === p2.horseNumber)
        || (b1 === p2.horseNumber && b2 === p1.horseNumber)
      ));

      // 2 horses are in top 2, in order
      b1 = parseInt(umatan.$inputs[0].value);
      b2 = parseInt(umatan.$inputs[1].value);
      checkWin(umatan, done && !umatan.$inputs[0].disabled && (
        b1 === p1.horseNumber && b2 === p2.horseNumber
      ));

      // 2 horses are in top 3, any order
      b1 = parseInt(wide.$inputs[0].value);
      b2 = parseInt(wide.$inputs[1].value);
      checkWin(wide, done && !wide.$inputs[0].disabled && (
        (b1 === p1.horseNumber || b1 === p2.horseNumber || b1 === p3.horseNumber)
        && (b2 === p1.horseNumber || b2 === p2.horseNumber || b2 === p3.horseNumber)
      ));

      // 3 horses are in top 3, any order
      b1 = parseInt(sanrenfuku.$inputs[0].value);
      b2 = parseInt(sanrenfuku.$inputs[1].value);
      b3 = parseInt(sanrenfuku.$inputs[2].value);
      checkWin(sanrenfuku, done && !sanrenfuku.$inputs[0].disabled && (
        (b1 === p1.horseNumber || b1 === p2.horseNumber || b1 === p3.horseNumber)
        && (b2 === p1.horseNumber || b2 === p2.horseNumber || b2 === p3.horseNumber)
        && (b3 === p1.horseNumber || b3 === p2.horseNumber || b3 === p3.horseNumber)
      ));

      // 3 horses horses are in top 3, in order
      b1 = parseInt(umarentan.$inputs[0].value);
      b2 = parseInt(umarentan.$inputs[1].value);
      b3 = parseInt(umarentan.$inputs[2].value);
      checkWin(umarentan, done && !umarentan.$inputs[0].disabled && (
        b1 === p1.horseNumber && b2 === p2.horseNumber && b3 === p3.horseNumber
      ));
    }

    function checkWin(bet, win) {
      bet.$inputs[0].parentElement.style.background = win ? COLOURS.WIN : COLOURS.DEFAULT;
    }

    $settings.addEventListener('change', () => adjustBets($numHorses.value));

    // init
    $numHorses.value = MAX_HORSES;
    let event = document.createEvent('HTMLEvents');
    event.initEvent('change', true, false);
    $numHorses.dispatchEvent(event);
  </script>
</html>
