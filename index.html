<html>
  <head>
  </head>
  <body>
    <div id="race_container">
      <table id="track">
        <tr>
          <th class="bracket-number">Êû†Áï™</th>
          <th class="horse-number">È¶¨Áï™</th>
          <th class="lane"></th>
          <th class="place">ÁùÄ</th>
        <tr>
      </table>
    </div>
    <div id="settings" cellspacing="0">
      <table>
        <tr>
          <td>Number of Horses:</td>
          <td>
            <input class="js-num-horses">
          </td>
          <td>
            <button>Start</button>
          </td>
        </tr>
        <tr id="bet_tanshou">
          <td class="bet">ÂçòÂãù(„Åü„Çì„Åó„Çá„ÅÜ - Win)</td>
          <td class="options">
            <input></input>
          </td>
          <td class="desc">Bet which horse will place 1st</td>
        </tr>
        <tr id="bet_fukushou">
          <td class="bet">Ë§áÂãù(Ë§áÂãù - Places)</td>
          <td class="options">
            <input></input>
          </td>
          <td class="desc">Bet which horse will place top 3 (top 2 if there are &lt; 8 horses)</td>
        </tr>
        <tr id="bet_wakutan">
          <td class="bet">Êû†Âçò(„Çè„Åè„Åü„Çì - Bracket Exacta)</td>
          <td class="options">
            <input></input>
          </td>
          <td class="desc">Bet which bracket's horse will place 1st</td>
        </tr>
        <tr id="bet_wakufuku">
          <td class="bet">Êû†Ë§á(„Çè„Åè„Åµ„Åè - Quinella)</td>
          <td class="options">
            <input></input> ‚Äï <input></input>
          </td>
          <td class="desc">
            Bet which brackets' horses will place top 2, in any order<br>
            Also called Êû†ÈÄ£(„Çè„Åè„Çå„Çì)
          </td>
        </tr>
        <tr id="bet_umafuku">
          <td class="bet">È¶¨Ë§á(„ÅÜ„Åæ„Åµ„Åè - Quinella)</td>
          <td class="options">
            <input></input> ‚Äï <input></input>
          </td>
          <td class="desc">
            Bet which 2 horses will place top 2, in any order<br>
            Also called È¶¨ÈÄ£(„ÅÜ„Åæ„Çå„Çì)
          </td>
        </tr>
        <tr id="bet_umatan">
          <td class="bet">È¶¨Âçò(„ÅÜ„Åæ„Åü„Çì - Exacta)</td>
          <td class="options">
            <input></input> ‚Üí <input></input>
          </td>
          <td class="desc">Bet which 2 horses will place top 2, in order (difficult)</td>
        </tr>
        <tr id="bet_wide">
          <td class="bet">„ÉØ„Ç§„Éâ(Wide)</td>
          <td class="options">
            <input></input> ‚Äï <input></input>
          </td>
          <td class="desc">Bet which 2 horses will place top 3, in any order</td>
        </tr>
        <tr id="bet_umarentan">
          <td class="bet">3ÈÄ£Âçò(„Åï„Çì„Çå„Çì„Åü„Çì - Trifecta)</td>
          <td class="options">
            <input></input> ‚Üí <input></input> ‚Üí <input></input>
          </td>
          <td class="desc">Bet which 3 horses will place top 3, in order (this is the most difficult)</td>
        </tr>
        <tr id="bet_sanrenfuku">
          <td class="bet">3ÈÄ£Ë§á(„Åï„Çì„Çå„Çì„Åµ„Åè - Trio)</td>
          <td class="options">
            <input></input> ‚Äï <input></input> ‚Äï <input></input>
          </td>
          <td class="desc">Bet which 3 horses will place top 3, in any order</td>
        </tr>
      </table>
    </div>
  </body>

  <style>
    body { padding: 10px; }
    #track,
    #track th,
    #track td, { border: 1px solid #000; }
    #track { width: 50%; }
      #track .bracket-number,
      #track .horse-number,
      #track .place { width: 5%; }
      #track .lane { width: 85%; }
      #track .bracket-1 { background: #DDD; }
      #track .bracket-2 { background: #666; }
      #track .bracket-3 { background: #F66; }
      #track .bracket-4 { background: #66F; }
      #track .bracket-5 { background: #FF6; }
      #track .bracket-6 { background: #6F6; }
      #track .bracket-7 { background: #FB9; }
      #track .bracket-8 { background: #F9B; }

    #settings { margin-top: 10px; }
      #settings th, td {
        border: 1px solid #999;
        padding: 3px;
      }
      #settings input:disabled { background: #EEE; }
  </style>

  <script>
    const MIN_HORSES = 1;
    const MAX_HORSES = 16;
    const BRACKET_SIZE = 2;
    const MAX_BRACKETS = MAX_HORSES / BRACKET_SIZE;

    var $track = document.querySelector('#track');
    var $numHorses = document.querySelector('.js-num-horses');
    var brackets = [];

    var $tanshou = document.querySelector('#bet_tanshou');
    var $fukushou = document.querySelector('#bet_fukushou');
    var $wakutan = document.querySelector('#bet_wakutan');
    var $wakufuku = document.querySelector('#bet_wakufuku');
    var $umatan = document.querySelector('#bet_umatan');
    var $umafuku = document.querySelector('#bet_umafuku');
    var $wide = document.querySelector('#bet_wide');
    var $umarentan = document.querySelector('#bet_umarentan');
    var $sanrenfuku = document.querySelector('#bet_sanrenfuku');

    $numHorses.addEventListener('change', function () {
      console.log('onChange');
      this.value = Math.min(MAX_HORSES, Math.max(MIN_HORSES, this.value)) || 1;

      clearTrack();
      makeBrackets(this.value);
      fillTrack();

      if (this.value <= MAX_BRACKETS) {
        document.querySelectorAll('.bracket').forEach(function ($bracket) {
          $bracket.style['visibility'] = 'hidden';
        });
      }

      adjustBets(this.value);
    });

    function clearTrack() {
      for (var i = 0; i < MAX_BRACKETS; i++) {
        brackets[i] = [];
      }

      var $lane = undefined;
      while ($lane = document.querySelector('.js-lane')) $lane.remove();
    }

    function makeBrackets(numHorses) {
      console.log('makeBrackets');

      for (var i = 1; i <= numHorses; i++) {
        bracket = ((MAX_BRACKETS * 2) - i) % MAX_BRACKETS;

        var $lane = document.createElement('tr');
        $lane.className = 'js-lane';

        var $horseNumber = document.createElement('td');
        $lane.appendChild($horseNumber);

        var $horse = document.createElement('td');
        $horse.innerText = 'üê¥';
        $horse.className = 'js-horse-' + i;
        $lane.appendChild($horse);

        var $place = document.createElement('td');
        $lane.appendChild($place);

        brackets[bracket].push({
          $html: $lane,
          $horseNumber: $horseNumber,
          $horse: $horse,
          $place: $place,
        });
      }
    }

    function fillTrack() {
      console.log('fillTrack');

      var horseNumber = 1;
      for (var i = 0; i < brackets.length; i++) {
        if (brackets[i].length === 0) continue;

        var $bracketNumber = document.createElement('td');
        $bracketNumber.className = 'bracket bracket-' + (i + 1);
        $bracketNumber.innerText = i + 1;
        $bracketNumber.rowSpan = brackets[i].length;
        brackets[i][0].$html.insertBefore($bracketNumber, brackets[i][0].$horseNumber);

        for (var j = 0; j < brackets[i].length; j++) {
          brackets[i][j].$horseNumber.innerText = horseNumber;
          horseNumber += 1;
          $track.append(brackets[i][j].$html);
        }
      }
    }

    function adjustBets(numHorses) {
      if (numHorses <= MAX_BRACKETS) {
        disableInputs($wakutan);
        disableInputs($wakufuku);

        if (numHorses < 5) {
          disableInputs($fukushou);

          if (numHorses < 4) {
            disableInputs($wide);
            disableInputs($umarentan);
            disableInputs($sanrenfuku);

            if (numHorses < 3) {
              disableInputs($umafuku)
              disableInputs($umatan);

              if (parseInt(numHorses) === 1) {
                disableInputs($tanshou);
              }
            }
          }
        }
      }
    }

    function disableInputs($bet) {
      $bet.querySelectorAll('input').forEach(function ($input) {
        $input.disabled = true;
      });
    }

    // init
    $numHorses.value = MAX_HORSES;
    var event = document.createEvent('HTMLEvents');
    event.initEvent('change', true, false);
    $numHorses.dispatchEvent(event);
  </script>
</html>
