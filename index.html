<html>
  <head>
  </head>
  <body>
    <div id="race_container">
      <table id="track">
        <tr>
          <th id="bracket_header" class="bracket-header">Êû†Áï™</th>
          <th class="horse-number">È¶¨Áï™</th>
          <th class="lane"></th>
          <th class="place">ÁùÄ</th>
        <tr>
      </table>
    </div>
    <div id="settings" cellspacing="0">
      <table>
        <tr>
          <td>Number of Horses:</td>
          <td>
            <input id="num_horses">
          </td>
          <td>
            <button id="start">Start</button>
          </td>
        </tr>
        <tr id="bet_tanshou">
          <td class="bet">ÂçòÂãù(„Åü„Çì„Åó„Çá„ÅÜ - Win)</td>
          <td class="options">
            <input></input>
          </td>
          <td class="desc">Bet which horse will place 1st</td>
        </tr>
        <tr id="bet_fukushou">
          <td class="bet">Ë§áÂãù(„Åµ„Åè„Åó„Çá„ÅÜ - Places)</td>
          <td class="options">
            <input></input>
          </td>
          <td class="desc">Bet which horse will place top 3 (top 2 if there are &lt; 8 horses)</td>
        </tr>
        <tr id="bet_wakufuku">
          <td class="bet">Êû†Ë§á(„Çè„Åè„Åµ„Åè - Bracket Quinella)</td>
          <td class="options">
            <input></input> ‚Äï <input></input>
          </td>
          <td class="desc">
            Bet which brackets' horses will place top 2, in any order<br>
            Also called Êû†ÈÄ£(„Çè„Åè„Çå„Çì)
          </td>
        </tr>
        <tr id="bet_wakutan">
          <td class="bet">Êû†Âçò(„Çè„Åè„Åü„Çì - Bracket Exacta)</td>
          <td class="options">
            <input></input> ‚Üí <input></input>
          </td>
          <td class="desc">Bet which brackets' horses will place top 2, in order</td>
        </tr>
        <tr id="bet_umafuku">
          <td class="bet">È¶¨Ë§á(„ÅÜ„Åæ„Åµ„Åè - Quinella)</td>
          <td class="options">
            <input></input> ‚Äï <input></input>
          </td>
          <td class="desc">
            Bet which 2 horses will place top 2, in any order<br>
            Also called È¶¨ÈÄ£(„ÅÜ„Åæ„Çå„Çì)
          </td>
        </tr>
        <tr id="bet_umatan">
          <td class="bet">È¶¨Âçò(„ÅÜ„Åæ„Åü„Çì - Exacta)</td>
          <td class="options">
            <input></input> ‚Üí <input></input>
          </td>
          <td class="desc">Bet which 2 horses will place top 2, in order (difficult)</td>
        </tr>
        <tr id="bet_wide">
          <td class="bet">„ÉØ„Ç§„Éâ(Wide)</td>
          <td class="options">
            <input></input> ‚Äï <input></input>
          </td>
          <td class="desc">Bet which 2 horses will place top 3, in any order</td>
        </tr>
        <tr id="bet_sanrenfuku">
          <td class="bet">3ÈÄ£Ë§á(„Åï„Çì„Çå„Çì„Åµ„Åè - Trio)</td>
          <td class="options">
            <input></input> ‚Äï <input></input> ‚Äï <input></input>
          </td>
          <td class="desc">Bet which 3 horses will place top 3, in any order</td>
        </tr>
        <tr id="bet_umarentan">
          <td class="bet">3ÈÄ£Âçò(„Åï„Çì„Çå„Çì„Åü„Çì - Trifecta)</td>
          <td class="options">
            <input></input> ‚Üí <input></input> ‚Üí <input></input>
          </td>
          <td class="desc">Bet which 3 horses will place top 3, in order (this is the most difficult)</td>
        </tr>
      </table>
    </div>
  </body>

  <style>
    body { padding: 10px; }
    #track,
    #track th,
    #track td, { border: 1px solid #000; }
    #track { width: 50%; }
      #track .bracket-header,
      #track .horse-number,
      #track .place { width: 5%; }
      #track .lane { width: 85%; }
      #track .bracket-1 { background: #DDD; }
      #track .bracket-2 { background: #666; }
      #track .bracket-3 { background: #F66; }
      #track .bracket-4 { background: #66F; }
      #track .bracket-5 { background: #FF6; }
      #track .bracket-6 { background: #6F6; }
      #track .bracket-7 { background: #FB9; }
      #track .bracket-8 { background: #F9B; }
      #track .horse {
        width: 0;
        text-align: right;
      }

    #settings { margin-top: 10px; }
      #settings th, td {
        border: 1px solid #999;
        padding: 3px;
      }
      #settings input:disabled { background: #EEE; }
  </style>

  <script>
    const MIN_HORSES = 1;
    const MAX_HORSES = 16;
    const BRACKET_SIZE = 2;
    const NUM_BRACKETS = MAX_HORSES / BRACKET_SIZE;
    const RACE_INTERVAL = 1000 / 30; // fps
    const SPEED = 3;

    const COLOURS = {
      GOLD: '#EE5',
      SILVER: '#DDE',
      BRONZE: '#BA6',
      WIN: '#6F6',
      DEFAULT: '#FFF',
    };

    const $track = document.querySelector('#track');
    const $bracketHeader = document.querySelector('#bracket_header');
    const $numHorses = document.querySelector('#num_horses');
    const $start = document.querySelector('#start');
    const brackets = [];

    const $tanshou = document.querySelectorAll('#bet_tanshou input');
    const $fukushou = document.querySelectorAll('#bet_fukushou input');
    const $wakufuku = document.querySelectorAll('#bet_wakufuku input');
    const $wakutan = document.querySelectorAll('#bet_wakutan input');
    const $umafuku = document.querySelectorAll('#bet_umafuku input');
    const $umatan = document.querySelectorAll('#bet_umatan input');
    const $wide = document.querySelectorAll('#bet_wide input');
    const $sanrenfuku = document.querySelectorAll('#bet_sanrenfuku input');
    const $umarentan = document.querySelectorAll('#bet_umarentan input');

    let intervalId = null;
    let places = [];

    $numHorses.addEventListener('change', function () {
      console.log('onChange');
      this.value = Math.min(MAX_HORSES, Math.max(MIN_HORSES, this.value)) || 1;

      clearTrack();
      makeBrackets(this.value);
      fillTrack();

      if (this.value <= NUM_BRACKETS) {
        $bracketHeader.style.display = 'none';
        document.querySelectorAll('.js-bracket').forEach(function ($bracket) {
          $bracket.style.display = 'none';
        });
      } else {
        $bracketHeader.style.display = 'table-cell';
      }

      adjustBets(this.value);
    });

    function clearTrack() {
      for (let i = 0; i < NUM_BRACKETS; i++) {
        brackets[i] = [];
      }

      let $lane = undefined;
      while ($lane = document.querySelector('.js-lane')) $lane.remove();
    }

    function makeBrackets(numHorses) {
      console.log('makeBrackets');

      for (let i = 1; i <= numHorses; i++) {
        bracket = ((NUM_BRACKETS * 2) - i) % NUM_BRACKETS;

        const $lane = document.createElement('tr');
        $lane.className = 'js-lane';

        const $horseNumber = document.createElement('td');
        $lane.appendChild($horseNumber);

        const $horseHolder = document.createElement('td');
        const $horse = document.createElement('div');
        $horse.innerText = 'üê¥';
        $horse.className = 'horse';
        $horseHolder.appendChild($horse);
        $lane.appendChild($horseHolder);

        const $place = document.createElement('td');
        $lane.appendChild($place);

        brackets[bracket].push({
          $html: $lane,
          $horseNumber: $horseNumber,
          $horse: $horse,
          $place: $place,
          bracketNumber: 0,
          horseNumber: 0,
        });
      }
    }

    function fillTrack() {
      console.log('fillTrack');

      let horseNumber = 1;
      for (let i = 0; i < brackets.length; i++) {
        if (brackets[i].length === 0) continue;

        const bracketNumber = i + 1;

        const $bracketNumber = document.createElement('td');
        $bracketNumber.className = 'js-bracket bracket-' + bracketNumber;
        $bracketNumber.innerText = bracketNumber;
        $bracketNumber.rowSpan = brackets[i].length;
        brackets[i][0].$html.insertBefore($bracketNumber, brackets[i][0].$horseNumber);

        for (let j = 0; j < brackets[i].length; j++) {
          brackets[i][j].bracketNumber = bracketNumber;
          brackets[i][j].horseNumber = horseNumber
          brackets[i][j].$horseNumber.innerText = horseNumber;
          horseNumber += 1;
          $track.append(brackets[i][j].$html);
        }
      }
    }

    function adjustBets(numHorses) {
      disableInputs($wakutan, numHorses <= NUM_BRACKETS);
      disableInputs($wakufuku, numHorses <= NUM_BRACKETS);
      disableInputs($fukushou, numHorses < 5);
      disableInputs($wide, numHorses < 4);
      disableInputs($umarentan, numHorses < 4);
      disableInputs($sanrenfuku, numHorses < 4);
      disableInputs($umafuku, numHorses < 3)
      disableInputs($umatan, numHorses < 3);
      disableInputs($tanshou, parseInt(numHorses) === 1);
    }

    function disableInputs($bet, disabled) {
      $bet.forEach(function ($input) {
        $input.disabled = disabled;
      });
    }

    $start.addEventListener('click', function () {
      if (intervalId !== null) return;

      console.log('start race with ' + $numHorses.value + ' horses');

      // reset
      for (let i = 0; i < brackets.length; i++) {
        for (let j = 0; j < brackets[i].length; j++) {
          brackets[i][j].$horse.style.width = 0;
          brackets[i][j].$place.innerText = '';
          brackets[i][j].$place.style.background = COLOURS.DEFAULT;
        }
      }
      places = [];
      checkBets();

      intervalId = window.setInterval(function () {
        for (let i = 0; i < brackets.length; i++) {
          for (let j = 0; j < brackets[i].length; j++) {
            let progress = parseInt(brackets[i][j].$horse.style.width) || 0;

            if (progress >= 100) continue;

            progress += Math.ceil(Math.random() * SPEED);

            if (progress >= 100) finishHorse(brackets[i][j]);

            brackets[i][j].$horse.style.width = Math.min(100, progress) + '%';
          }
        }

        if (places.length == $numHorses.value) {
          window.clearInterval(intervalId);
          intervalId = null;
          checkBets();
        }
      }, RACE_INTERVAL);
    });

    function finishHorse(horse) {
      places.push(horse);
      horse.$place.innerText = places.length;

      if (places.length === 1) {
        horse.$place.style.background = COLOURS.GOLD;
      } else if (places.length === 2) {
        horse.$place.style.background = COLOURS.SILVER;
      } else if (places.length === 3) {
        horse.$place.style.background = COLOURS.BRONZE;
      }

      console.log('horse #' + horse.horseNumber + ' (bracket #' + horse.bracketNumber + ') finishes');
    }

    function checkBets() {
      const done = places.length > 0;
      const p1 = places[0];
      const p2 = places[1];
      const p3 = places[2];

      let b1 = 0;
      let b2 = 0;
      let b3 = 0;

      // horse is 1st
      b1 = parseInt($tanshou[0].value);
      checkWin($tanshou, done && !$tanshou[0].disabled && (
        b1 === p1.horseNumber
      ));

      // horse is in top 3 (top 2 if < 8 horses)
      b1 = parseInt($fukushou[0].value);
      checkWin($fukushou, done && !$fukushou[0].disabled && (
          b1 === p1.horseNumber
          || b1 === p2.horseNumber
          || ($numHorses.value > NUM_BRACKETS && b1 === p3.horseNumber)
      ));

      // 2 brackets' horses are in top 2, any order
      b1 = parseInt($wakufuku[0].value);
      b2 = parseInt($wakufuku[1].value);
      checkWin($wakufuku, done && !$wakufuku[0].disabled && (
        (b1 === p1.bracketNumber && b2 === p2.bracketNumber)
        || (b1 === p2.bracketNumber && b2 === p1.bracketNumber)
      ));

      // 2 brackets' horse are in top 2, in order
      b1 = parseInt($wakutan[0].value);
      b2 = parseInt($wakutan[1].value);
      checkWin($wakutan, done && !$wakutan[0].disabled && (
        b1 === p1.bracketNumber && b2 === p2.bracketNumber
      ));

      // 2 horses are in top 2, any order
      b1 = parseInt($umafuku[0].value);
      b2 = parseInt($umafuku[1].value);
      checkWin($umafuku, done && !$umafuku[0].disabled && (
        (b1 === p1.horseNumber && b2 === p2.horseNumber)
        || (b1 === p2.horseNumber && b2 === p1.horseNumber)
      ));

      // 2 horses are in top 2, in order
      b1 = parseInt($umatan[0].value);
      b2 = parseInt($umatan[1].value);
      checkWin($umatan, done && !$umatan[0].disabled && (
        b1 === p1.horseNumber && b2 === p2.horseNumber
      ));

      // 2 horses are in top 3, any order
      b1 = parseInt($wide[0].value);
      b2 = parseInt($wide[1].value);
      checkWin($wide, done && !$wide[0].disabled && (
        (b1 === p1.horseNumber || b1 === p2.horseNumber || b1 === p3.horseNumber)
        && (b2 === p1.horseNumber || b2 === p2.horseNumber || b2 === p3.horseNumber)
      ));

      // 3 horses are in top 3, any order
      b1 = parseInt($sanrenfuku[0].value);
      b2 = parseInt($sanrenfuku[1].value);
      b3 = parseInt($sanrenfuku[2].value);
      checkWin($sanrenfuku, done && !$sanrenfuku[0].disabled && (
        (b1 === p1.horseNumber || b1 === p2.horseNumber || b1 === p3.horseNumber)
        && (b2 === p1.horseNumber || b2 === p2.horseNumber || b2 === p3.horseNumber)
        && (b3 === p1.horseNumber || b3 === p2.horseNumber || b3 === p3.horseNumber)
      ));

      // 3 horses horses are in top 3, in order
      b1 = parseInt($umarentan[0].value);
      b2 = parseInt($umarentan[1].value);
      b3 = parseInt($umarentan[2].value);
      checkWin($umarentan, done && !$umarentan[0].disabled && (
        b1 === p1.horseNumber && b2 === p2.horseNumber && b3 === p3.horseNumber
      ));
    }

    function checkWin($bet, win) {
      $bet[0].parentElement.style.background = win ? COLOURS.WIN : COLOURS.DEFAULT;
    }

    // init
    $numHorses.value = MAX_HORSES;
    let event = document.createEvent('HTMLEvents');
    event.initEvent('change', true, false);
    $numHorses.dispatchEvent(event);
  </script>
</html>
