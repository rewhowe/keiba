<html>
  <head>
  </head>
  <body>
    <div id="race_container">
      <table id="track">
        <tr>
          <th id="bracket_header" class="bracket-header">
            枠番<br>
            <span class="text-small">Bracket #</span>
          </th>
          <th class="horse-number">
            馬番<br>
            <span class="text-small">Horse #</span>
          </th>
          <th class="lane">
            <span class="start text-small">Start</span>
            <span class="finish text-small">Finish</span>
          </th>
          <th class="place">
            着<br>
            <span class="text-small">Place</span>
          </th>
        <tr>
      </table>
    </div>
    <div id="controls">
      Number of Horses:
      <input type="number" id="num_horses">
      <button id="start">Start</button>
    </div>
    <div id="settings" cellspacing="0">
      <table>
        <tr>
          <th>賭式(かけしき - Bet)</th>
          <th>Options</th>
          <th>%</th>
          <th>Winning Choice(s)</th>
        </tr>
        <tr id="bet_tanshou">
          <td class="bet">
            単勝(たんしょう - Win)
            <div class="info">
              ?<div class="desc">Bet which horse will place 1st</div>
            </div>
          </td>
          <td class="options">
            <input type="number"></input>
          </td>
          <td class="probability js-probability"></td>
          <td class="js-win-choice"></td>
        </tr>
        <tr id="bet_fukushou">
          <td class="bet">
            複勝(ふくしょう - Places)
            <div class="info">
              ?<div class="desc">Bet which horse will place top 3 (top 2 if there are &lt; 8 horses)</div>
            </div>
          </td>
          <td class="options">
            <input type="number"></input>
          </td>
          <td class="probability js-probability"></td>
          <td class="js-win-choice"></td>
        </tr>
        <tr id="bet_wakufuku">
          <td class="bet">
            枠複(わくふく - Bracket Quinella)
            <div class="info">
              ?<div class="desc">Bet which brackets' horses will place top 2, in any order; Also called 枠連(わくれん)</div>
            </div>
          </td>
          <td class="options">
            <input type="number"></input> ― <input type="number"></input>
          </td>
          <td class="probability js-probability"></td>
          <td class="js-win-choice"></td>
        </tr>
        <tr id="bet_wakutan">
          <td class="bet">
            枠単(わくたん - Bracket Exacta)
            <div class="info">
              ?<div class="desc">Bet which brackets' horses will place top 2, in order</div>
            </div>
          </td>
          <td class="options">
            <input type="number"></input> → <input type="number"></input>
          </td>
          <td class="probability js-probability"></td>
          <td class="js-win-choice"></td>
        </tr>
        <tr id="bet_umafuku">
          <td class="bet">
            馬複(うまふく - Quinella)
            <div class="info">
              ?<div class="desc">Bet which 2 horses will place top 2, in any order; Also called 馬連(うまれん)</div>
            </div>
          </td>
          <td class="options">
            <input type="number"></input> ― <input type="number"></input>
          </td>
          <td class="probability js-probability"></td>
          <td class="js-win-choice"></td>
        </tr>
        <tr id="bet_umatan">
          <td class="bet">
            馬単(うまたん - Exacta)
            <div class="info">
              ?<div class="desc">Bet which 2 horses will place top 2, in order (difficult)</div>
            </div>
          </td>
          <td class="options">
            <input type="number"></input> → <input type="number"></input>
          </td>
          <td class="probability js-probability"></td>
          <td class="js-win-choice"></td>
        </tr>
        <tr id="bet_wide">
          <td class="bet">
            ワイド(Wide)
            <div class="info">
              ?<div class="desc">Bet which 2 horses will place top 3, in any order</div>
            </div>
          </td>
          <td class="options">
            <input type="number"></input> ― <input type="number"></input>
          </td>
          <td class="probability js-probability"></td>
          <td class="js-win-choice"></td>
        </tr>
        <tr id="bet_sanrenfuku">
          <td class="bet">
            3連複(さんれんふく - Trio)
            <div class="info">
              ?<div class="desc">Bet which 3 horses will place top 3, in any order</div>
            </div>
          </td>
          <td class="options">
            <input type="number"></input> ― <input type="number"></input> ― <input type="number"></input>
          </td>
          <td class="probability js-probability"></td>
          <td class="js-win-choice"></td>
        </tr>
        <tr id="bet_umarentan">
          <td class="bet">
            3連単(さんれんたん - Trifecta)
            <div class="info">
              ?<div class="desc">
                Bet which 3 horses will place top 3, in order (most difficult); Also called 3連単(さんれんたん)
              </div>
            </div>
          </td>
          <td class="options">
            <input type="number"></input> → <input type="number"></input> → <input type="number"></input>
          </td>
          <td class="probability js-probability"></td>
          <td class="js-win-choice"></td>
        </tr>
      </table>
    </div>
  </body>

  <style>
    body { padding: 10px; }
    #track th,
    #track td,
    #settings th,
    #settings td { border: 1px solid #999; }

    #track { width: 50%; }
      #track .bracket-header,
      #track .horse-number,
      #track .place {
        width: 5%;
        white-space: nowrap;
      }
      #track .lane { width: 85%; }
      #track .bracket-1 { background: #DDD; }
      #track .bracket-2 { background: #666; }
      #track .bracket-3 { background: #F66; }
      #track .bracket-4 { background: #66F; }
      #track .bracket-5 { background: #FF6; }
      #track .bracket-6 { background: #6F6; }
      #track .bracket-7 { background: #FB9; }
      #track .bracket-8 { background: #F9B; }
      #track .horse {
        width: 0;
        text-align: right;
      }

    #controls { padding-top: 20px; }

    #settings { margin-top: 10px; }
      #settings th,
      #settings td { padding: 10px; }
      #settings tr.win td { background: #6F6; }
      #settings input:disabled { background: #EEE; }

    .text-small { font-size: 80%; }
    .start { float: left; }
    .finish { float: right; }
    .probability {
      width: 4em;
      text-align: right;
    }
      .probability:after { content: '％'; }
    .info {
      display: inline-block;
      position: relative;
      border: 1px solid #33B;
      border-radius: 15px;
      padding: 5px 10px;
      margin-left: 10px;
      line-height: 18px;
        float: right;
    }
      .info .desc { display: none; }
      .info:hover {
        color: transparent;
        background: #EEF;
        cursor: pointer;
      }
        .info:hover .desc {
          position: absolute;
          display: block;
          top: -1;
          left: 15px;
          width: max-content;
          color: #000;
          background: #EEF;
          border: 1px solid #33B;
          border-left: none;
          padding: 5px 5px 5px 10px;
        }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
  </style>

  <script>
    const MIN_HORSES = 1;
    const MAX_HORSES = 16;
    const BRACKET_SIZE = 2;
    const NUM_BRACKETS = MAX_HORSES / BRACKET_SIZE;
    const RACE_INTERVAL = 1000 / 30; // fps
    const SPEED = 3;

    const COLOURS = {
      GOLD: '#EE5',
      SILVER: '#DDE',
      BRONZE: '#BA6',
      DEFAULT: '#FFF',
    };

    const SORT_NUM = (a, b) => a - b;

    const $track = document.querySelector('#track');
    const $bracketHeader = document.querySelector('#bracket_header');
    const $numHorses = document.querySelector('#num_horses');
    const $start = document.querySelector('#start');
    const $settings = document.querySelector('#settings');
    const brackets = [];

    const tanshou = {
      $row: document.querySelector('#bet_tanshou'),
      $inputs: document.querySelectorAll('#bet_tanshou input'),
      $probability: document.querySelector('#bet_tanshou .js-probability'),
      $win: document.querySelector('#bet_tanshou .js-win-choice'),
    };
    const fukushou = {
      $row: document.querySelector('#bet_fukushou'),
      $inputs: document.querySelectorAll('#bet_fukushou input'),
      $probability: document.querySelector('#bet_fukushou .js-probability'),
      $win: document.querySelector('#bet_fukushou .js-win-choice'),
    };
    const wakufuku = {
      $row: document.querySelector('#bet_wakufuku'),
      $inputs: document.querySelectorAll('#bet_wakufuku input'),
      $probability: document.querySelector('#bet_wakufuku .js-probability'),
      $win: document.querySelector('#bet_wakufuku .js-win-choice'),
    };
    const wakutan = {
      $row: document.querySelector('#bet_wakutan'),
      $inputs: document.querySelectorAll('#bet_wakutan input'),
      $probability: document.querySelector('#bet_wakutan .js-probability'),
      $win: document.querySelector('#bet_wakutan .js-win-choice'),
    };
    const umafuku = {
      $row: document.querySelector('#bet_umafuku'),
      $inputs: document.querySelectorAll('#bet_umafuku input'),
      $probability: document.querySelector('#bet_umafuku .js-probability'),
      $win: document.querySelector('#bet_umafuku .js-win-choice'),
    };
    const umatan = {
      $row: document.querySelector('#bet_umatan'),
      $inputs: document.querySelectorAll('#bet_umatan input'),
      $probability: document.querySelector('#bet_umatan .js-probability'),
      $win: document.querySelector('#bet_umatan .js-win-choice'),
    };
    const wide = {
      $row: document.querySelector('#bet_wide'),
      $inputs: document.querySelectorAll('#bet_wide input'),
      $probability: document.querySelector('#bet_wide .js-probability'),
      $win: document.querySelector('#bet_wide .js-win-choice'),
    };
    const sanrenfuku = {
      $row: document.querySelector('#bet_sanrenfuku'),
      $inputs: document.querySelectorAll('#bet_sanrenfuku input'),
      $probability: document.querySelector('#bet_sanrenfuku .js-probability'),
      $win: document.querySelector('#bet_sanrenfuku .js-win-choice'),
    };
    const umarentan = {
      $row: document.querySelector('#bet_umarentan'),
      $inputs: document.querySelectorAll('#bet_umarentan input'),
      $probability: document.querySelector('#bet_umarentan .js-probability'),
      $win: document.querySelector('#bet_umarentan .js-win-choice'),
    };

    let intervalId = null;
    let places = [];

    $numHorses.addEventListener('change', function () {
      this.value = Math.min(MAX_HORSES, Math.max(MIN_HORSES, this.value)) || 1;

      clearTrack();
      makeBrackets(this.value);
      fillTrack();

      if (this.value <= NUM_BRACKETS) {
        $bracketHeader.style.display = 'none';
        document.querySelectorAll('.js-bracket').forEach($bracket => $bracket.style.display = 'none');
      } else {
        $bracketHeader.style.display = 'table-cell';
      }

      adjustBets(this.value);
    });

    function clearTrack() {
      for (let i = 0; i < NUM_BRACKETS; i++) {
        brackets[i] = [];
      }

      document.querySelectorAll('.js-lane').forEach($lane => $lane.remove());
    }

    function makeBrackets(numHorses) {
      for (let i = 1; i <= numHorses; i++) {
        bracket = ((NUM_BRACKETS * 2) - i) % NUM_BRACKETS;

        const $lane = document.createElement('tr');
        $lane.className = 'js-lane';

        const $horseNumber = document.createElement('td');
        $lane.appendChild($horseNumber);

        const $horseHolder = document.createElement('td');
        const $horse = document.createElement('div');
        $horse.innerText = '🐴';
        $horse.className = 'horse';
        $horseHolder.appendChild($horse);
        $lane.appendChild($horseHolder);

        const $place = document.createElement('td');
        $lane.appendChild($place);

        brackets[bracket].push({
          $html: $lane,
          $horseNumber: $horseNumber,
          $horse: $horse,
          $place: $place,
          bracketNumber: 0,
          horseNumber: 0,
        });
      }
    }

    function fillTrack() {
      let horseNumber = 1;
      for (let i = 0; i < brackets.length; i++) {
        if (brackets[i].length === 0) continue;

        const bracketNumber = i + 1;

        const $bracketNumber = document.createElement('td');
        $bracketNumber.className = 'js-bracket bracket-' + bracketNumber;
        $bracketNumber.innerText = bracketNumber;
        $bracketNumber.rowSpan = brackets[i].length;
        brackets[i][0].$html.insertBefore($bracketNumber, brackets[i][0].$horseNumber);

        for (let j = 0; j < brackets[i].length; j++) {
          brackets[i][j].bracketNumber = bracketNumber;
          brackets[i][j].horseNumber = horseNumber
          brackets[i][j].$horseNumber.innerText = horseNumber;
          horseNumber += 1;
          $track.append(brackets[i][j].$html);
        }
      }
    }

    function adjustBets(numHorses) {
      update(tanshou, parseInt(numHorses) === 1, function () {
        if (1 <= input(tanshou, 0) && input(tanshou, 0) <= numHorses) {
          return 1 / numHorses;
        }
        return 0;
      });
      update(fukushou, numHorses < 5, function () {
        if (1 <= input(fukushou, 0) && input(fukushou, 0) <= numHorses) {
          return (numHorses < NUM_BRACKETS ? 2 : 3) / numHorses;
        }
        return 0;
      });
      update(wakufuku, numHorses <= NUM_BRACKETS, function () {
        let bracket1Length = (brackets[input(wakufuku, 0) - 1] || []).length;
        let bracket2Length = (brackets[input(wakufuku, 1) - 1] || []).length;
        return (bracket1Length * bracket2Length * 2) / (numHorses * (numHorses - 1));
      });
      update(wakutan, numHorses <= NUM_BRACKETS, function () {
        let bracket1Length = (brackets[input(wakutan, 0) - 1] || []).length;
        let bracket2Length = (brackets[input(wakutan, 1) - 1] || []).length;
        return (bracket1Length * bracket2Length) / (numHorses * (numHorses - 1));
      });
      update(umafuku, numHorses < 3, function () {
        if (1 <= input(umafuku, 0) && input(umafuku, 0) <= numHorses
          && 1 <= input(umafuku, 1) && input(umafuku, 1) <= numHorses
        ) {
          return 2 / (numHorses * (numHorses - 1));
        }
        return 0;
      });
      update(umatan, numHorses < 3, function () {
        if (1 <= input(umatan, 0) && input(umatan, 0) <= numHorses
          && 1 <= input(umatan, 1) && input(umatan, 1) <= numHorses
        ) {
          return 1 / (numHorses * (numHorses - 1));
        }
        return 0;
      });
      update(wide, numHorses < 4, function () {
        if (1 <= input(wide, 0) && input(wide, 0) <= numHorses
          && 1 <= input(wide, 1) && input(wide, 1) <= numHorses
        ) {
          return 6 / (numHorses * (numHorses - 1));
        }
        return 0;
      });
      update(sanrenfuku, numHorses < 4, function () {
        if (1 <= input(sanrenfuku, 0) && input(sanrenfuku, 0) <= numHorses
          && 1 <= input(sanrenfuku, 1) && input(sanrenfuku, 1) <= numHorses
          && 1 <= input(sanrenfuku, 2) && input(sanrenfuku, 2) <= numHorses
        ) {
          return 6 / (numHorses * (numHorses - 1) * (numHorses - 2));
        }
        return 0;
      });
      update(umarentan, numHorses < 4, function () {
        if (1 <= input(umarentan, 0) && input(umarentan, 0) <= numHorses
          && 1 <= input(umarentan, 1) && input(umarentan, 1) <= numHorses
          && 1 <= input(umarentan, 2) && input(umarentan, 2) <= numHorses
        ) {
          return 1 / (numHorses * (numHorses - 1) * (numHorses - 2));
        }
        return 0;
      });
    }

    function update(bet, disabled, calculate) {
      let hasInput = true;
      bet.$inputs.forEach(function ($input) {
        $input.disabled = disabled;
        hasInput &= ($input.value != '');
      });

      bet.$probability.innerText = hasInput && !disabled ? Math.round(calculate() * 10000) / 100 : 0;
    }

    $start.addEventListener('click', function () {
      if (intervalId !== null) return;

      console.log('start race with ' + $numHorses.value + ' horses');

      // reset
      for (let i = 0; i < brackets.length; i++) {
        for (let j = 0; j < brackets[i].length; j++) {
          brackets[i][j].$horse.style.width = 0;
          brackets[i][j].$place.innerText = '';
          brackets[i][j].$place.style.background = COLOURS.DEFAULT;
        }
      }
      places = [];
      clearBets();

      intervalId = window.setInterval(function () {
        for (let i = 0; i < brackets.length; i++) {
          for (let j = 0; j < brackets[i].length; j++) {
            let progress = parseInt(brackets[i][j].$horse.style.width) || 0;

            if (progress >= 100) continue;

            progress += Math.ceil(Math.random() * SPEED);

            if (progress >= 100) finishHorse(brackets[i][j]);

            brackets[i][j].$horse.style.width = Math.min(100, progress) + '%';
          }
        }

        if (places.length == $numHorses.value) {
          window.clearInterval(intervalId);
          intervalId = null;
          checkBets();
        }
      }, RACE_INTERVAL);
    });

    function finishHorse(horse) {
      places.push(horse);
      horse.$place.innerText = places.length;

      if (places.length === 1) {
        horse.$place.style.background = COLOURS.GOLD;
      } else if (places.length === 2) {
        horse.$place.style.background = COLOURS.SILVER;
      } else if (places.length === 3) {
        horse.$place.style.background = COLOURS.BRONZE;
      }

      console.log('horse #' + horse.horseNumber + ' (bracket #' + horse.bracketNumber + ') finishes');
    }

    function clearBets() {
      [
        tanshou,
        fukushou,
        wakufuku,
        wakutan,
        umafuku,
        umatan,
        wide,
        sanrenfuku,
        umarentan,
      ].forEach(function (bet) {
        bet.$row.className = '';
        bet.$win.innerText = '';
      });
    }

    function checkBets() {
      if (!places[0]) return;

      let winChoices = [];

      // horse is 1st
      winChoices = [
        places[0].horseNumber.toString(),
      ];
      checkWin(tanshou, winChoices);
      showWin(tanshou, winChoices);

      if (!places[1]) return;

      // horse is in top 3 (top 2 if < 8 horses)
      winChoices = [
        places[0].horseNumber.toString(),
        places[1].horseNumber.toString(),
      ];
      if ($numHorses.value > NUM_BRACKETS) winChoices.push(places[2].horseNumber.toString());
      checkWin(fukushou, winChoices);
      showWin(fukushou, winChoices)

      // 2 brackets' horses are in top 2, any order
      winChoices = [
        [places[0].bracketNumber, places[1].bracketNumber].sort(SORT_NUM).join('―'),
        [places[1].bracketNumber, places[0].bracketNumber].sort(SORT_NUM).join('―'),
      ];
      checkWin(wakufuku, winChoices, '―');
      showWin(wakufuku, winChoices);

      // 2 brackets' horse are in top 2, in order
      winChoices = [
        [places[0].bracketNumber, places[1].bracketNumber].join('→'),
      ];
      checkWin(wakutan, winChoices, '→');
      showWin(wakutan, winChoices);

      // 2 horses are in top 2, any order
      winChoices = [
        [places[0].horseNumber, places[1].horseNumber].sort(SORT_NUM).join('―'),
      ];
      checkWin(umafuku, winChoices, '―');
      showWin(umafuku, winChoices);

      // 2 horses are in top 2, in order
      winChoices = [
        [places[0].horseNumber, places[1].horseNumber].join('→'),
      ];
      checkWin(umatan, winChoices, '→');
      showWin(umatan, winChoices);

      if (!places[2]) return;

      // 2 horses are in top 3, any order
      winChoices = [
        [places[0].horseNumber, places[1].horseNumber].sort(SORT_NUM).join('―'),
        [places[1].horseNumber, places[2].horseNumber].sort(SORT_NUM).join('―'),
        [places[2].horseNumber, places[0].horseNumber].sort(SORT_NUM).join('―'),
      ];
      checkWin(wide, winChoices, '―');
      showWin(wide, winChoices);

      // 3 horses are in top 3, any order
      winChoices = [
        [places[0].horseNumber, places[1].horseNumber, places[2].horseNumber].sort(SORT_NUM).join('―'),
      ];
      checkWin(sanrenfuku, winChoices, '―');
      showWin(sanrenfuku, winChoices);

      // 3 horses horses are in top 3, in order
      winChoices = [
        [places[0].horseNumber, places[1].horseNumber, places[2].horseNumber].join('→'),
      ];
      checkWin(umarentan, winChoices, '→');
      showWin(umarentan, winChoices);
    }

    function checkWin(bet, winChoices, delim = '') {
      if (bet.$inputs[0].disabled) return;

      let choices = [];
      bet.$inputs.forEach(($input) => choices.push($input.value))

      if (winChoices.indexOf(choices.join(delim)) === -1) return;

      bet.$row.className = 'win';
    }

    function showWin(bet, winChoices) {
      bet.$win.innerText = winChoices.join(', ');
    }

    function input(bet, index) {
      return parseInt(bet.$inputs[index].value);
    }

    $settings.addEventListener('change', () => adjustBets($numHorses.value));

    // init
    $numHorses.value = MAX_HORSES;
    const event = document.createEvent('HTMLEvents');
    event.initEvent('change', true, false);
    $numHorses.dispatchEvent(event);
  </script>
</html>
